name: Deploy Backend to Tencent Cloud

# è§¦å‘æ¡ä»¶ï¼šå½“æœ‰ä»£ç  push åˆ° main åˆ†æ”¯æ—¶
on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    # è¿è¡Œç¯å¢ƒï¼šä½¿ç”¨æœ€æ–°çš„ Ubuntu è™šæ‹ŸæœåŠ¡å™¨
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ä¸€æ­¥ï¼šæ£€å‡ºï¼ˆä¸‹è½½ï¼‰ä½ çš„ä»“åº“ä»£ç åˆ°è™šæ‹Ÿç¯å¢ƒä¸­
      - name: Checkout code
        uses: actions/checkout@v4

      # ç¬¬äºŒæ­¥ï¼šé€šè¿‡ SSH è¿æ¥åˆ°ä½ çš„æœåŠ¡å™¨å¹¶æ‰§è¡Œéƒ¨ç½²è„šæœ¬
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22 # SSH é»˜è®¤ç«¯å£
          known_hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
          script: |
            echo "ğŸš€ Starting deployment..."
            cd /root/tinkerers-blog-backend # ç¡®ä¿è¿™æ˜¯ä½ æœåŠ¡å™¨ä¸Šåç«¯é¡¹ç›®çš„æ­£ç¡®è·¯å¾„
            echo "â¡ï¸ Pulling latest code from main branch..."
            git pull origin main
            echo "ğŸ“¦ Installing dependencies..."
            npm install
            echo "ğŸ”„ Reloading application with PM2..."
            pm2 reload blog-backend || pm2 start server.js --name "blog-backend"
            echo "âœ… Deployment finished successfully!"